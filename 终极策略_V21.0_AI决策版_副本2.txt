### **交易系统终极版：V21.0 "AI决策版" - AI防错实现指南**

==============================================================================
**⚠️ AI实现警告：本文档是V6.0的进化版，融合了机器学习模型。请严格区分历史训练与未来预测，避免数据泄露！**
==============================================================================

#### **核心理念**
- **V6.0 "基石"**: 提供高质量、无重复的交易信号源 (V型底)。
- **V21.0 "引擎"**: 在V6的基础上，用AI模型从高质量信号中筛选出“精英选手”，并对它们进行动态仓位管理，旨在大幅提升胜率和期望收益。

---

#### **第1步：寻找高质量猎物 (V6核心信号源)**

**入场条件数学表达**：
*   连续4天收盘价不减：A≤B≤C≤D
*   V型底：第0天的收盘价是过去n个交易日的最低点 (n≥20)。

**执行动作**：当且仅当以上所有条件全部满足时，识别为一个**备选信号**。

🚨 **AI容易错误理解的地方1 - 信号唯一性 (V6核心)**：
- V型底是本策略的“地基”，它确保了我们只在趋势的**起始点**生成信号，从根本上杜绝了在同一上涨趋势中产生大量重复、低质量信号的问题。
- 索引和天数对应关系与V6.0完全相同 (第0天 = `i-4`, 第4天 = `i`)。

---

#### **第2步：AI大脑评估 (模型预测与筛选)**

**执行动作1：提取特征**
- 对每一个通过第1步筛选的“备选信号”，在**入场当天**（第4天 D）计算以下13个维度的特征。

🚨 **AI容易错误理解的地方2 - 特征工程**：
- **这13个特征是AI决策的全部依据**。它们必须严格使用信号发生当天及之前的历史数据计算，绝不能包含未来信息。
- **特征列表**: `rsi_14`, `rsi_30`, `atr_ratio`, `body_ratio`, `upper_shadow_ratio`, `lower_shadow_ratio`, `vol_amp`, `amount_amp`, `ma5_above_ma10`, `close_above_ma5`, `gap_open`, `consecutive_up_days`, `bottom_depth`。

**执行动作2：模型预测**
- 使用一个**预先训练好**的LightGBM回归模型，输入上述13个特征，模型会输出一个“预测收益”分。

🚨 **AI容易错误理解的地方3 - 模型训练 (最最关键！)**：
- **严格区分“训练”和“预测”**：模型必须在**历史数据**上完成训练，保存下来，然后在未来的新数据上进行预测。
- **训练集的构建**:
    - `X` (特征): 历史上一大批V6信号的13个特征。
    - `y` (标签): 这些历史信号在未来一段时间内（例如10天）的**真实收益率**。
- **禁止数据泄露**: 训练时，模型通过学习历史上的“特征”与“未来真实结果”的关联，建立起自己的“知识体系”。在未来的实盘预测中，模型**绝对不能**接触到未来的真实收益率。**它是在用历史知识，预测一个完全未知的未来**。这解决了您最担心的“反向推断”问题。

**执行动作3：精英筛选**
- 根据所有备选信号的“预测收益”分进行排序。
- **只保留预测分数最高的前20%** 作为最终的“精英交易信号”。(这个百分比可以调整)

---

#### **第3步：动态仓位出击 (收益放大)**

**执行动作**：只对通过了第2步筛选的“精英信号”进行交易，并采用动态仓位。
*   **高信心仓位 (2倍)**: 如果一个精英信号的“预测收益”分在所有精英信号中也排在前75%，则使用2倍仓位。
*   **普通信心仓位 (0.5倍)**: 其他精英信号，使用0.5倍仓位。

---

#### **第4步：设置防线与管理交易 (V6经典风控)**

**执行动作**：对所有精英交易，严格执行V6.0的风险管理和退出机制。
*   **硬止损**: 止损价 = 买入价 × (1 - 0.031)。此规则拥有最高优先级。
*   **豁免期**: 买入后第一天如果亏损，直接忽略，不操作。
*   **分级减仓**: 豁免期后，若当日收盘价低于前一日收盘价，则根据跌幅（0%-2%之间卖10%，>2%卖20%）分级减仓。

🚨 **AI容易错误理解的地方4 - 收益计算与风控**：
- 此处的实现与V6.0文档完全一致。
- 必须正确累计每次分级减仓的收益 (`total_pnl`)。
- 必须正确使用`is_first_drop`标志来管理豁免期。
- 最终收益需要乘以第3步中计算出的仓位倍数 (2.0或0.5)。
  `final_pnl_with_leverage = total_pnl * position_multiplier`

---

==============================================================================
**📋 V21.0实现检查清单**
==============================================================================
✅ **信号生成**: 严格遵循V6的“连续上涨+V型底”逻辑，确保信号无重复。
✅ **特征计算**: 确保13个特征全部在信号发生的当天计算，无未来函数。
✅ **模型训练**: 坚决杜绝数据泄露，用历史数据的真实收益作为标签(y)进行训练。
✅ **精英筛选**: 正确使用分位数（例如`quantile(0.8)`）筛选出Top 20%的信号。
✅ **风控逻辑**: 完全复用V6.0文档中经过验证的硬止损、豁免期、分级减仓代码。
✅ **最终收益**: 记得将模拟出的`total_pnl`乘以动态仓位倍数。

==============================================================================
**🎯 V21.0预期结果范围 (Top 20%精英信号)**
==============================================================================
- **胜率**: 65% - 75%
- **期望收益**: 6.0% - 8.0%
- **交易次数**: 约为V6总信号的20% (例如，从5万个备选信号中选出1万个)
- **关键特征**: 模型应显示`rsi_30`, `bottom_depth`, `atr_ratio`等为最重要特征。

**如果结果严重偏离，请检查**：
1. **信号源是否正确**: 是否误用了V18的重复信号逻辑？
2. **模型训练是否泄露**: 是否在训练中使用了未来信息？
3. **风控代码是否照搬V6**: 是否在减仓或收益计算上自行简化了？
4. **筛选百分比是否正确**: `quantile(1 - top_percentile)`。

记住：V21.0的成功，建立在**干净的信号源（V6）** 和 **强大的AI放大器（V18/19）** 的正确结合之上！ 